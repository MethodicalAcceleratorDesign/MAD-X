# |
# o---------------------------------------------------------------------o
# |
# | MAD GC makefile for Linux
# |
# o---------------------------------------------------------------------o
# |
# | Garbage collector for MAD-X (Boehm GC)
# |
# | For more information, see http://cern.ch/mad
# |
# o---------------------------------------------------------------------o
# |
# | $Id$
# |

#
# Linux
#

$(PROJECT):   libgc-gnu

libgc-gnu:    libgc-gnu32   libgc-gnu64
libgc-llvm:   libgc-llvm32  libgc-llvm64
libgc-intel:  libgc-intel32 libgc-intel64

libgc-%32:    ARCH := 32
libgc-%64:    ARCH := 64

cleanarch:
	$E "** Cleaning binaries and libraries"
	$_ $(RM) $(wildcard libgc32* libgc64* libgc-linux*)

libgc-intel32 libgc-intel64:
	$E "*** Building $@"
	$_ cd $(GCDIR) ; \
	env CC="icc -m$(ARCH) -DLARGE_CONFIG" ./configure --enable-static --disable-shared --with-pic \
	    $(if $(call eq,$(OPENMP),yes),--enable-threads=posix,--disable-threads) ; \
	make clean ; make ; make check ; cd - ; \
	cp -f $(GCDIR)/.libs/libgc.a libgc-linux$(ARCH)-intel.a ; \
	ln -sf libgc-linux$(ARCH)-intel.a libgc$(ARCH)-intel.a

libgc-gnu32 libgc-gnu64:
	$E "*** Building $@"
	$_ cd $(GCDIR) ; \
	env CC="gcc -m$(ARCH) -DLARGE_CONFIG" ./configure --enable-static --disable-shared --with-pic \
	    $(if $(call eq,$(OPENMP),yes),--enable-threads=posix,--disable-threads) ; \
	make clean ; make ; make check ; cd - ; \
	cp -f $(GCDIR)/.libs/libgc.a libgc-linux$(ARCH)-gnu.a ; \
	ln -sf libgc-linux$(ARCH)-gnu.a libgc$(ARCH)-gnu.a

libgc-llvm32 libgc-llvm64:
	$E "*** Building $@"
	$_ cd $(GCDIR) ; \
	env CC="clang -m$(ARCH) -DLARGE_CONFIG" ./configure --enable-static --disable-shared --with-pic \
	    $(if $(call eq,$(OPENMP),yes),--enable-threads=posix,--disable-threads) ; \
	make clean ; make ; make check ; cd - ; \
	cp -f $(GCDIR)/.libs/libgc.a libgc-linux$(ARCH)-llvm.a ; \
	ln -sf libgc-linux$(ARCH)-llvm.a libgc$(ARCH)-llvm.a

# end of makefile
